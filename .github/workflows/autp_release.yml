name: Auto version

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to put in pom'
        required: false

env:
  # conditionals envs

  VERSION: ${{ github.event.inputs.version }}
  ACT_HAS_VERSION: ${{ github.event.inputs.version != '' }}
  NEW_BRANCH: release/${{ github.event.inputs.version }}
  # workflow envs
  APP_NAME: Auto version test

jobs:
  change_versions:
    runs-on: ubuntu-latest
    container:
      image: maven:3.8.4-eclipse-temurin-17

    steps:
      - name: Checkout APP repository
        uses: actions/checkout@v3
      - name: Create release branch
        run: git checkout -b ${{env.NEW_BRANCH}}
      - name: Initialize mandatory git config
        run: |
          git config user.name "Auto version"
          git config user.email customerapp@wefox.com
      - name: Execute vbum for version ${{env.VERSION}}
        shell: bash
        run: |
          mvn versions:set -DnewVersion=${{env.VERSION}}
          mvn versions:commit
          sed -i  -E 's/(image: wefox\/.+:)(.+)/\1$version/g' docker-compose.yml
      - name: Commit changelog and manifest files
        id: make-commit
        run: |
          git status
          git add .
          git commit --message "Auto pom changes for ${{ env.VERSION }}"
          echo "::set-output name=commit::$(git rev-parse HEAD)"
      - name: Push new branch
        run: git push origin release/${{env.VERSION}}

